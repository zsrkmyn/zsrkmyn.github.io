<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Stephen's Home - posts</title><link href="https://zsrkmyn.github.io/" rel="alternate"></link><link href="https://zsrkmyn.github.io/feeds/posts.atom.xml" rel="self"></link><id>https://zsrkmyn.github.io/</id><updated>2024-03-12T00:00:00+08:00</updated><entry><title>数字货币合约套利</title><link href="https://zsrkmyn.github.io/crypto-coin-arbitrage.html" rel="alternate"></link><published>2024-03-12T00:00:00+08:00</published><updated>2024-03-12T00:00:00+08:00</updated><author><name>Stephen Zhang</name></author><id>tag:zsrkmyn.github.io,2024-03-12:/crypto-coin-arbitrage.html</id><summary type="html">&lt;div class="contents topic" id="contents"&gt;
&lt;p class="topic-title"&gt;Contents&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id18"&gt;概述&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id19"&gt;永续合约套利&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id20"&gt;币本位永续合约做空套期保值&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id5" id="id21"&gt;举例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id6" id="id22"&gt;币本位永续合约的多倍做空&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#u" id="id23"&gt;U 本位永续合约做空套期保值&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id7" id="id24"&gt;U 本位永续合约多倍做空&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id8" id="id25"&gt;做空永续合约实现套利&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id9" id="id26"&gt;做空永续合约的年化收益&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id10" id="id27"&gt;交易佣金&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id11" id="id28"&gt;滑点&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id12" id="id29"&gt;交割合约套利&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id13" id="id30"&gt;币本位交割合约做空套利&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id14" id="id31"&gt;举例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id15" id="id32"&gt;U 本位交割合约做空套利&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id16" id="id33"&gt;交割合约套利的年化收益&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id17" id="id34"&gt;总结&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id18"&gt;概述&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;开始前先声明，数字货币市场就是一个不受监管的大赌场，本文只分析合约套利原理，不构成投资建议。永远对市场抱有敬畏之心。投资有风险，入市需谨慎。&lt;/p&gt;
&lt;p&gt;首先，我是一个坚定的数字货币反对者。我理解有些人衷爱数字货币，或许因为他们在数字货币的游戏中赚的盆满钵满，或许是他们认为数字货币改变了分配关系，我不去辩驳，毕竟每个人对世界但看法不一样。我认为，数字货币不过是人人都可制造的毫无价值的“货币”。人人都可以发行新的数字货币，就好像人人都可以制造印钞机。既然人人都能制造印钞机，那么印出来的钞票的价值在哪里？所以，数字货币不过是一场零和游戏，有人赚得盆满钵满，就有人亏得血本无归。比特币创立时的美好愿景——去中心化、匿名 …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;div class="contents topic" id="contents"&gt;
&lt;p class="topic-title"&gt;Contents&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id18"&gt;概述&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id19"&gt;永续合约套利&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id20"&gt;币本位永续合约做空套期保值&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id5" id="id21"&gt;举例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id6" id="id22"&gt;币本位永续合约的多倍做空&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#u" id="id23"&gt;U 本位永续合约做空套期保值&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id7" id="id24"&gt;U 本位永续合约多倍做空&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id8" id="id25"&gt;做空永续合约实现套利&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id9" id="id26"&gt;做空永续合约的年化收益&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id10" id="id27"&gt;交易佣金&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id11" id="id28"&gt;滑点&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id12" id="id29"&gt;交割合约套利&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id13" id="id30"&gt;币本位交割合约做空套利&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id14" id="id31"&gt;举例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id15" id="id32"&gt;U 本位交割合约做空套利&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id16" id="id33"&gt;交割合约套利的年化收益&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id17" id="id34"&gt;总结&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id18"&gt;概述&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;开始前先声明，数字货币市场就是一个不受监管的大赌场，本文只分析合约套利原理，不构成投资建议。永远对市场抱有敬畏之心。投资有风险，入市需谨慎。&lt;/p&gt;
&lt;p&gt;首先，我是一个坚定的数字货币反对者。我理解有些人衷爱数字货币，或许因为他们在数字货币的游戏中赚的盆满钵满，或许是他们认为数字货币改变了分配关系，我不去辩驳，毕竟每个人对世界但看法不一样。我认为，数字货币不过是人人都可制造的毫无价值的“货币”。人人都可以发行新的数字货币，就好像人人都可以制造印钞机。既然人人都能制造印钞机，那么印出来的钞票的价值在哪里？所以，数字货币不过是一场零和游戏，有人赚得盆满钵满，就有人亏得血本无归。比特币创立时的美好愿景——去中心化、匿名、币值稳定——更是一个都没有实现。&lt;/p&gt;
&lt;p&gt;不过，最近我发现这场游戏有点意思，哪怕不下赌场，也可以了解下赌局的规则，学习下最基本的金融知识，看看赌场里的人生百态。数字货币的游戏规则复杂，但是理解其中的部分规则，也许能在游戏中分一杯羹，或者即便分不到羹，找点乐子也不错。（也许现在说这样的话显得有些过于自信，希望我不会有亏得血本无归得那一天。）&lt;/p&gt;
&lt;p&gt;阅读本文需要一些最最基本的期货知识。现在互联网发达，随便一搜都能搜到。&lt;/p&gt;
&lt;p&gt;阅读本文前推荐阅读《&lt;a class="reference external" href="https://taresky.com/crypto-arbitrage"&gt;无风险年化 360%？小白也能懂的 Crypto 套利&lt;/a&gt;》。本文仅对其中提到的套利原理做简要分析和扩展补充，故不对投资收益和风险做评价，也不给出实际的操作方案。本文介绍的套利分为永续合约套利和交割合约套利，下面进入正题。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id19"&gt;永续合约套利&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;我决定先讲币本位做空的套利，再讲 U 本位做空的套利。因为前者更复杂，搞懂了复杂的东西，简单的东西自然很好理解。如果你觉得币本位太复杂，可以直接跳到 U 本位。&lt;/p&gt;
&lt;div class="section" id="id4"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id20"&gt;币本位永续合约做空套期保值&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;首先明确，永续合约的价格永远向现货价格收敛，即我们可以认为永续合约价格约等于现货价格。原因我们后面解释。所以，这节中我们提到的开仓价和平仓价，既是合约价格，也是现货价格。&lt;/p&gt;
&lt;p&gt;币本位合约自带 1 倍做多属性，所以币本位 1 倍做空，相当于抵消了 1 倍做多，永远不会爆仓，具体后面会解释。但是要防范自动减仓（ADL）的风险。&lt;/p&gt;
&lt;p&gt;不考虑套利，先看币本位做空永续合约的收益计算。假设杠杆倍数为 N，币本位做空永续合约的收益如下，&lt;/p&gt;
&lt;div class="formula"&gt;
&lt;span class="environment"&gt;&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
&lt;i&gt;收益&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;)
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;&lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × &lt;i&gt;N&lt;/i&gt; × (&lt;i&gt;开仓价&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;)&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;平仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
&lt;span class="text"&gt;... (1)&lt;/span&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;(&lt;i&gt;合约数&lt;/i&gt; × &lt;i&gt;合约面值&lt;/i&gt;) ⁄ &lt;i&gt;开仓价&lt;/i&gt; × &lt;i&gt;N&lt;/i&gt; × (&lt;i&gt;开仓价&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;)&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;平仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;合约数&lt;/i&gt; × &lt;i&gt;合约面值&lt;/i&gt; × &lt;i&gt;N&lt;/i&gt; × (&lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;1&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;平仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt; − &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;1&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;开仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt;)
&lt;/span&gt;

&lt;/span&gt;
&lt;/span&gt;
&lt;/div&gt;
&lt;p&gt;上面 (1) 式中，收益变化是由杠杆倍数和币价变动决定的，即 &lt;span class="formula"&gt;&lt;i&gt;N&lt;/i&gt; × (&lt;i&gt;开仓价&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;)&lt;/span&gt; ，但这里的变化是以 U 计的，所以最后需要除以平仓价，将 U 转为币。&lt;/p&gt;
&lt;p&gt;因为我们的目的是套利，而不是持币，所以最终的收益要转换为 USDT。理想状况，合约平仓后，立即卖出币转为 USDT，则卖出价格为平仓价，所以以 USDT 计算的收益如下，&lt;/p&gt;
&lt;div class="formula"&gt;
&lt;span class="environment"&gt;&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
&lt;i&gt;收益&lt;/i&gt;(&lt;i&gt;以U计&lt;/i&gt;)
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;收益&lt;/i&gt; + &lt;i&gt;本金变动&lt;/i&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;收益&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × &lt;i&gt;平仓价&lt;/i&gt; + &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × (&lt;i&gt;平仓价&lt;/i&gt; − &lt;i&gt;开仓价&lt;/i&gt;)
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
&lt;span class="text"&gt;... 带入公式 (1)&lt;/span&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × &lt;i&gt;N&lt;/i&gt; × &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;(&lt;i&gt;开仓价&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;)&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;平仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt; × &lt;i&gt;平仓价&lt;/i&gt; + 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
    &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × (&lt;i&gt;平仓价&lt;/i&gt; − &lt;i&gt;开仓价&lt;/i&gt;)
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × (&lt;i&gt;N&lt;/i&gt; − 1) × (&lt;i&gt;开仓价&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;)
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;&lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以U计&lt;/i&gt;)&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;开仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt; × (&lt;i&gt;N&lt;/i&gt; − 1) × (&lt;i&gt;开仓价&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;)
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
&lt;span class="text"&gt;... (2)&lt;/span&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;

&lt;/span&gt;
&lt;/span&gt;
&lt;/div&gt;
&lt;p&gt;对比 N 倍杠杆的 U 本位做空的收益（即， &lt;span class="formula"&gt;&lt;i&gt;保证金&lt;/i&gt; ⁄ &lt;i&gt;开仓价&lt;/i&gt; × &lt;i&gt;N&lt;/i&gt; × (&lt;i&gt;开仓价&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;)&lt;/span&gt; ），可以注意到，币本位的实际杠杆变为了 N - 1，这就解释了上面提到了币本位合约自带 1 倍做多属性。有意思的事情发生了，如果以 1 倍杠杆按币本位做空合约，无论币价如何变动，以 U 计的收益永远为 0，这就是币本位合约的套期保值。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id5"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id21"&gt;举例&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;举例，假设开仓时，一个 BTC 的价格是 50,000 USDT，一张合约面值是等值 100 USDT 的 BTC（即 0.002 BTC）。我们准备买入 100 张 1 倍做空的合约，此时，我们需要 100 * 100 = 10,000 USDT。先将 10,000 USDT 换成 0.2 BTC，再以 0.2 BTC 买入 100 张做空合约。此时，我们就以 1 倍杠杆，用 0.2 BTC 做空了 0.2 BTC（没错，听起来很脑残，但我们就是花了 0.2 BTC 做空了 0.2 BTC，这也就是为什么以 U 计的收益永远为 0 的原因——币价的上涨/下跌永远抵消了做空的亏损/收益）。&lt;/p&gt;
&lt;p&gt;假设币价上涨到 100,000 USDT 时，我们平仓，那么我们将收获 0.2 * 1 * (50,000 - 100,000) / 100,000 = -0.1 个 BTC，手上剩余 0.1 个 BTC，卖出 BTC，换为 100,000 * 0.1 = 10,000 USDT。&lt;/p&gt;
&lt;p&gt;假设币价下跌到 40,000 USDT 时，我们平仓，那么我们将收获 0.2 * 1 * (50,000 - 40,000) / 40,000 = 0.05 个 BTC，手上剩余 0.25 个 BTC，卖出 BTC，得到 40,000 * 0.25 = 10,000 USDT。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id6"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id22"&gt;币本位永续合约的多倍做空&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;理论上来说，在币本位合约套利中，我们基本不会用到多倍做空（否则币价上涨带来的损失将会超过资金费的收益），但是在实际操作中，因为币价波动过快，可能存在滑点。为了防止因为滑点导致的开仓失败，通常会以较小的杠杆进行合约开仓（如 1.01 甚至 1.5 倍）。了解多倍做空有助于理解合约被强平的风险。&lt;/p&gt;
&lt;p&gt;现在来考虑 N != 1 的情况。当杠杆倍数不为 1 时，币本位做空会面临强制平仓/爆仓风险。现在我们来计算强平价格。当损失超过保证金，即 &lt;span class="formula"&gt;( − &lt;i&gt;收益&lt;/i&gt;) ≥ &lt;i&gt;保证金&lt;/i&gt;&lt;/span&gt; 时，会触发强平。所以，将 &lt;span class="formula"&gt;&lt;i&gt;收益&lt;/i&gt; =  − &lt;i&gt;保证金&lt;/i&gt;&lt;/span&gt; 带入 (2) 式中，可以计算出，&lt;/p&gt;
&lt;div class="formula"&gt;
&lt;i&gt;强制平仓价&lt;/i&gt; = &lt;i&gt;开仓价&lt;/i&gt; × (1 + &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;1&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;N&lt;/i&gt; − 1&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt;)
&lt;/div&gt;
&lt;p&gt;例如，如果我们以 2 倍杠杆做空，则强平价是 2 倍开仓价，即如果币价上涨一倍，我们就会血本无归。如果以 1.5 倍杠杆做空，则强平价是 3 倍开仓价。如果以 1.01 倍杠杆做空，则强平价是 101 倍开仓价。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="u"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id23"&gt;U 本位永续合约做空套期保值&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;U 本位永续合约套期保值相比币本位永续合约就简单很多了。开仓时，在现货市场买入一定量的币，同时以相同价格在 U 本位永续合约中做空相同数量的币；平仓时，现货与合约的盈亏相抵，本金变化为 0。这就是 U 本位永续合约的套期保值。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id7"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id24"&gt;U 本位永续合约多倍做空&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;N 倍杠杆 U 本位做空的收益为 &lt;span class="formula"&gt;&lt;i&gt;保证金&lt;/i&gt; ⁄ &lt;i&gt;开仓价&lt;/i&gt; × &lt;i&gt;N&lt;/i&gt; × (&lt;i&gt;开仓价&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;)&lt;/span&gt; 。类似地，当合约保证金不足以抵扣做空亏损时，会触发强平，&lt;/p&gt;
&lt;div class="formula"&gt;
&lt;i&gt;强制平仓价&lt;/i&gt; = &lt;i&gt;开仓价&lt;/i&gt; × (1 + &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;1&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;N&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt;)
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id8"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id25"&gt;做空永续合约实现套利&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;相比交割合约，永续合约没有交割期限，所以合约价格和现货价格可能永不收敛。通过定期（每 8 小时）让需求旺盛的一方向另一方缴纳“资金费”，可以促使需求旺盛的一方平仓以避免“资金费”，这样就能保证合约价格和现货价格基本保持一致。例如，当合约溢价率为正时（即合约价格 &amp;gt; 现货价格），由多头向空头支付资金费，且溢价率越高，资金费率也较高，这会促使多头平仓避免资金费，则合约价格会向现货价格收敛。反之亦然。&lt;/p&gt;
&lt;p&gt;市场行情好时，多头旺盛，资金费率高，通过套期保值做空永续合约，可以避免币价波动带来的本金波动，同时还能收取资金费。这就是做空永续合约套利的原理。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id9"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id26"&gt;做空永续合约的年化收益&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;懒得敲推导过程了，直接上结论。&lt;/p&gt;
&lt;div class="formula"&gt;
&lt;span class="environment"&gt;&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
&lt;i&gt;币本位年化收益率&lt;/i&gt;
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;资金费率&lt;/i&gt; × 3 × 365
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
&lt;i&gt;U&lt;/i&gt;&lt;i&gt;本位年化收益率&lt;/i&gt;
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;资金费率&lt;/i&gt; × 3 × 365 × &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;&lt;i&gt;N&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;N&lt;/i&gt; + 1&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;/span&gt;
&lt;/div&gt;
&lt;p&gt;可以看出，资金费率相同的情况下，币本位的资金利用率更高。同样是 1 倍杠杆，币本位的资金利用率是 100%，但 U 本位只有 50%。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id10"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id27"&gt;交易佣金&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;套利的同时要注意要交易佣金。在没有任何佣金折扣的情况下，OKX 完成一次完整的币本位永续合约套利，交易佣金大约是 0.25%。1 倍杠杆 U 本位佣金是币本位的 1/2，即 0.125%。计算过程留作作业。所以如果是短期套利，交易佣金可能吞噬你的资金费收益。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id11"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id28"&gt;滑点&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;尽管理论上买入现货和做空合约应当同时进行，且在上面的推导中，我们假设了合约价格 = 现货价格，但实际操作中，操作二者总会有时间差，且主流货币如 BTC 价格波动很快，这就可能导致合约币价 &amp;lt; 现货币价，而出现滑点。&lt;/p&gt;
&lt;p&gt;尤其在币本位永续合约中，我们需要先在现货市场买币，再用币作为保证金开仓合约。当合约币价 &amp;lt; 现货币价时，以 1 倍做空和现货等值 USDT 的合约可能需要多于买入的现货币数作为保证金，这可能导致开仓失败。这也是为何币本位合约开仓通常选择略大约 1 的杠杆倍数，以减少保证金数量，避免开仓失败。注意，这里只是合约的杠杆倍数选择略大于 1 以减少保证金，现货购买的币数可能略大于保证金，多余的部分仍然应该留在账户中，平仓时多余的部分也一起平掉，这样保证实际的做空杠杆倍数仍然是 1。&lt;/p&gt;
&lt;p&gt;举例，懒得举了，操作一遍就懂了。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id12"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id29"&gt;交割合约套利&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="id13"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id30"&gt;币本位交割合约做空套利&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;交割合约的币本位做空收益计算比永续合约稍微复杂。上一节已经提到过，永续合约的开仓单价和现货的单价是一样的，这是由每 8 小时收取的资金费率保证的。交割合约在交割日当天期货和现货价差应该收敛至 0 （否则就可以从现货市场买入现货然后在期货市场做空（卖出）交割套利，或在期货市场做多（买入）然后在现货市场卖出套利）。而在还未到期的交割合约中，合约的开仓价通常和现货价格有差异，且距离交割日越远，价差可能越大。因为从当日到交割日还有一段时间，这段时间的资金使用是需要付利息的，而价差的本质就是这段时间资金使用的利息。所以当期货价格 &amp;gt; 现货价格时，我们可以通过在现货市场做多（买入）币，在期货市场做空（卖出）币实现套利。&lt;/p&gt;
&lt;p&gt;现在我们来计算币本位交割合约的收益。首先明确，因为交割日当天期货与现货价差趋于 0，所以平仓价是一致的。定义开仓时的价差率如下，&lt;/p&gt;
&lt;div class="formula"&gt;
&lt;i&gt;价差率&lt;/i&gt; = &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;&lt;i&gt;期货开仓价&lt;/i&gt; − &lt;i&gt;现货开仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;现货开仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;p&gt;下面简写期货开仓价为“期开”，现货开仓价为“现开”。根据价差率公式，可得，&lt;/p&gt;
&lt;div class="formula"&gt;
&lt;i&gt;期开&lt;/i&gt; = (1 + &lt;i&gt;价差率&lt;/i&gt;) × &lt;i&gt;现开&lt;/i&gt;&lt;span class="text"&gt;    ... (3)&lt;/span&gt;
&lt;/div&gt;
&lt;p&gt;交割合约的以币计算的收益和永续合约的一样，将公式 (1) 中的“开仓价”换为“期开”就完成了。计算公式如下，&lt;/p&gt;
&lt;div class="formula"&gt;
&lt;span class="environment"&gt;&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
&lt;i&gt;收益&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;)
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;&lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × &lt;i&gt;N&lt;/i&gt; × (&lt;i&gt;期开&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;)&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;平仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
&lt;span class="text"&gt;... (4)&lt;/span&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;(&lt;i&gt;合约数&lt;/i&gt; × &lt;i&gt;合约面值&lt;/i&gt;) ⁄ &lt;i&gt;期开&lt;/i&gt; × &lt;i&gt;N&lt;/i&gt; × (&lt;i&gt;期开&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;)&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;平仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;合约数&lt;/i&gt; × &lt;i&gt;合约面值&lt;/i&gt; × &lt;i&gt;N&lt;/i&gt; × (&lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;1&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;平仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt; − &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;1&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;期开&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt;)
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;

&lt;/span&gt;
&lt;/span&gt;
&lt;/div&gt;
&lt;p&gt;类似永续合约，我们将以币计算的收益转为以 USDT 计算的收。永续合约中，我们假设了合约价格和现货价格的差总是趋于 0；而交割合约开仓时存在价差，所以计算过程比永续合约复杂，如下，&lt;/p&gt;
&lt;div class="formula"&gt;
&lt;span class="environment"&gt;&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
&lt;i&gt;收益&lt;/i&gt;(&lt;i&gt;以U计&lt;/i&gt;)
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;收益&lt;/i&gt; + &lt;i&gt;本金变动&lt;/i&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;收益&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × &lt;i&gt;平仓价&lt;/i&gt; + &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × (&lt;i&gt;平仓价&lt;/i&gt; − &lt;i&gt;现开&lt;/i&gt;)
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
&lt;span class="text"&gt;... 带入公式 (4)&lt;/span&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × &lt;i&gt;N&lt;/i&gt; × &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;&lt;i&gt;期开&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;平仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt; × &lt;i&gt;平仓价&lt;/i&gt; + 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
    &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × (&lt;i&gt;平仓价&lt;/i&gt; − &lt;i&gt;现开&lt;/i&gt;)
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
&lt;span class="text"&gt;... 带入公式 (3)&lt;/span&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × &lt;i&gt;N&lt;/i&gt; × ((1 + &lt;i&gt;价差率&lt;/i&gt;) × &lt;i&gt;现开&lt;/i&gt; − &lt;i&gt;平仓价&lt;/i&gt;) + 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
    &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × (&lt;i&gt;平仓价&lt;/i&gt; − &lt;i&gt;现开&lt;/i&gt;)
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以币计&lt;/i&gt;) × {[(&lt;i&gt;N&lt;/i&gt; − 1) + &lt;i&gt;N&lt;/i&gt; × &lt;i&gt;价差率&lt;/i&gt;] × &lt;i&gt;现开&lt;/i&gt; − (&lt;i&gt;N&lt;/i&gt; − 1) × &lt;i&gt;平仓价&lt;/i&gt;}
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;&lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以U计&lt;/i&gt;)&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;现开&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt; × {[(&lt;i&gt;N&lt;/i&gt; − 1) + &lt;i&gt;N&lt;/i&gt; × &lt;i&gt;价差率&lt;/i&gt;] × &lt;i&gt;现开&lt;/i&gt; − (&lt;i&gt;N&lt;/i&gt; − 1) × &lt;i&gt;平仓价&lt;/i&gt;}
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以U计&lt;/i&gt;) × [&lt;i&gt;N&lt;/i&gt; × &lt;i&gt;价差率&lt;/i&gt; − (&lt;i&gt;N&lt;/i&gt; − 1)(1 − &lt;span class="fraction"&gt;&lt;span class="ignored"&gt;(&lt;/span&gt;&lt;span class="numerator"&gt;&lt;i&gt;平仓价&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)/(&lt;/span&gt;&lt;span class="denominator"&gt;&lt;i&gt;现开&lt;/i&gt;&lt;/span&gt;&lt;span class="ignored"&gt;)&lt;/span&gt;&lt;/span&gt;)]
&lt;/span&gt;

&lt;/span&gt;
&lt;/span&gt;
&lt;/div&gt;
&lt;p&gt;这个公式可谓相当晦涩难懂了。但是没关系，我们还是使用 1 倍做空，即 N = 1。带入上式，收益就非常简单明了了，&lt;/p&gt;
&lt;div class="formula"&gt;
1&lt;i&gt;倍做空收益&lt;/i&gt;(&lt;i&gt;以U计&lt;/i&gt;) = &lt;i&gt;保证金&lt;/i&gt;(&lt;i&gt;以U计&lt;/i&gt;) × &lt;i&gt;价差率&lt;/i&gt;
&lt;/div&gt;
&lt;p&gt;从这个公式可以看出，虽然合约是币本位合约，即最终收益是币，但转换为 USDT 时，收益实际与开仓时和平仓时的币价无关。实际上，收益在开仓时，就已经由价差率决定了。&lt;/p&gt;
&lt;p&gt;额外插一句，在上式中，如果价差率为 0，即现货开仓价 = 合约开仓价，那么收益公式就和永续合约的收益一样了 :-D&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id14"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id31"&gt;举例&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;假设我们用 ETH 的交割合约套利。开仓时，现货价格为 1,000 USDT/ETH，合约价格为 2,000 USDT/ETH，距离交割日还有 90 天，价差率为 (2000 - 1000)/1000 = 100%。此时我们在现货市场用 10,000 USDT 购入 10 个 ETH，在期货市场用 10 ETH 做空 10 ETH （是不是熟悉的感觉？）。90 天后，现货价格变为 500 USDT/ETH，合约价格收敛至现货价格，此时我们平仓，则我们从合约中赚到了 10 * 1 * (2,000 - 500)/500 = 30 ETH，加上本金 10 ETH，总共 40 ETH。在现货市场卖出 40 ETH，换回 40 * 500 = 20,000 USDT，收益 10,000 USDT，刚好等于保证金（即初始本金）* 价差率。&lt;/p&gt;
&lt;p&gt;当然这个例子比较夸张，实际价差率没有那么高啦。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id15"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id32"&gt;U 本位交割合约做空套利&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;现在我们介绍了币本位和 U 本位永续合约的套利，又介绍了币本位交割合约的套利，U 本位交割合约的套利自然不在话下，所以我就不写了 (～￣▽￣)～&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id16"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id33"&gt;交割合约套利的年化收益&lt;/a&gt;&lt;/h3&gt;
&lt;div class="formula"&gt;
&lt;span class="environment"&gt;&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
&lt;i&gt;币本位年化收益率&lt;/i&gt;
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 = &lt;i&gt;价差率&lt;/i&gt; × 365 ⁄ &lt;i&gt;交割剩余天数&lt;/i&gt;
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;
 
&lt;/span&gt;
&lt;span class="arraycell align-l"&gt;
 
&lt;/span&gt;

&lt;/span&gt;
&lt;span class="arrayrow"&gt;
&lt;span class="arraycell align-r"&gt;

&lt;/span&gt;

&lt;/span&gt;
&lt;/span&gt;
&lt;/div&gt;
&lt;p&gt;U 本位年化收益率留作作业吧。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id17"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id34"&gt;总结&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;本文介绍了永续合约和交割合约的套利原理，其本质都可以简单地理解为收取资金使用利息。永续合约资金费率时刻变动，所以收益通常不确定，在市场行情好时，资金费率可能很高，收益也高。但数字货币市场千变万化，也许过 8 小时币价大跌，资金费率就变为负的了。而交割的收益通常在开仓时就确定，稳定性更高。另一方面，永续合约可以随时平仓，只要保证不要频繁开平仓，基本能维持正收益（资金费率为正的情况下）；而交割合约在交割前，价差率可能比开仓时更大，此时会出现浮亏，就只能等待价格收敛而不能平仓。&lt;/p&gt;
&lt;p&gt;最后再次声明，数字货币市场就是一个不受监管的大赌场，本文只分析合约套利原理，不构成投资建议。永远对市场抱有敬畏之心。投资有风险，入市需谨慎。&lt;/p&gt;
&lt;/div&gt;
</content></entry><entry><title>伪·如何在 Linux 下使用深信服 SSL VPN</title><link href="https://zsrkmyn.github.io/how-to-use-sangfor-sslvpn-in-linux.html" rel="alternate"></link><published>2018-01-12T00:00:00+08:00</published><updated>2018-01-12T00:00:00+08:00</updated><author><name>Stephen Zhang</name></author><id>tag:zsrkmyn.github.io,2018-01-12:/how-to-use-sangfor-sslvpn-in-linux.html</id><summary type="html">&lt;div class="contents topic" id="contents"&gt;
&lt;p class="topic-title"&gt;Contents&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id4"&gt;背景&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id5"&gt;配置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id6"&gt;画张图&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;背景&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;本文大概会很水……&lt;/p&gt;
&lt;p&gt;由于要在外网访问校内的资源，包括实验室的服务器什么的，所以学校提供了接入校内的 VPN 服务。三本院校的采用国内著名的深信服 SSL VPN。众所周知，国内各种企业的产品都是没有 Linux 版本的，所以要在 Linux 下使用深信服的 SSL VPN，还是得装个虚拟机 _(:з」∠)_ 好了，感觉读到这里你要就失望了，哎，没办法呀，有谁去破解下辣鸡深信服的 SSL VPN 协议呗？&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;配置&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;嗯，用 qemu 装个 Bugdows，在 Bugdows 上装个深信服的 EasyConnect。&lt;/p&gt;
&lt;p&gt;在 Linux 下创建一个 bridge：&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
ip …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;div class="contents topic" id="contents"&gt;
&lt;p class="topic-title"&gt;Contents&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id4"&gt;背景&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id5"&gt;配置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id6"&gt;画张图&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;背景&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;本文大概会很水……&lt;/p&gt;
&lt;p&gt;由于要在外网访问校内的资源，包括实验室的服务器什么的，所以学校提供了接入校内的 VPN 服务。三本院校的采用国内著名的深信服 SSL VPN。众所周知，国内各种企业的产品都是没有 Linux 版本的，所以要在 Linux 下使用深信服的 SSL VPN，还是得装个虚拟机 _(:з」∠)_ 好了，感觉读到这里你要就失望了，哎，没办法呀，有谁去破解下辣鸡深信服的 SSL VPN 协议呗？&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;配置&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;嗯，用 qemu 装个 Bugdows，在 Bugdows 上装个深信服的 EasyConnect。&lt;/p&gt;
&lt;p&gt;在 Linux 下创建一个 bridge：&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
ip l add qbr0 type bridge
ip l set qbr0 up
&lt;/pre&gt;
&lt;p&gt;启动虚拟机的时候需要给 Windows 添加两块网卡，一块采用 user 模式，也就是 &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Slirp"&gt;SLiRP&lt;/a&gt; 模式，另一块采用 bridge 模式：&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
qemu-system-x86-64 \
-netdev user,id=mynet0,net=192.168.76.0/24,dhcpstart=192.168.76.9 \
-device virtio-net,netdev=mynet0 \
-netdev bridge,id=mynet1,br=qbr0 \
-device virtio-net,netdev=mynet1 \
...
&lt;/pre&gt;
&lt;p&gt;这一步 qemu 会利用 qemu-bridge-helper 自动创建一个 tap 设备，并且把这个 tap 连到 qbr0 里。因为 qemu-bridge-helper 是 setuid 的，qemu-bridge-helper 会检查授权，如果这一步出现 ACL 错误提示，需要在 &lt;tt class="docutils literal"&gt;/etc/qemu/bridge.conf&lt;/tt&gt; 里添加上 &lt;tt class="docutils literal"&gt;allow qbr0&lt;/tt&gt; ，如果要允许接入任意的网桥，就添加 &lt;tt class="docutils literal"&gt;allow all&lt;/tt&gt; 。&lt;/p&gt;
&lt;p&gt;启动 Windows，启动 EasyConnect，这时 Windows 下应该出现 3 块网卡，一块 user 模式，我们叫它「Network 1」，一块是 bridge 模式，叫他「Network 2」，还有一个是 SSL VPN 的虚拟网卡，叫它「spicy chicken sangfor」。下面把 Linux 称为 Host，Windows 称为 Guest。&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;「Network 1」用于接入互联网，这块网卡只能从 Guest 访问 Host，没法从 Host 访问 Guest，类似与 vbox 的 NAT 模式；&lt;/li&gt;
&lt;li&gt;「Network 2」用于 Host 和 Guest 间的相互通信，这里主要是把 Host 的数据传个 VPN；&lt;/li&gt;
&lt;li&gt;「spicy chicken sangfor」当然是用来访问内网了。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这时候共享 「spicy chicken sangfor」，右键属性 -&amp;gt; 共享 -&amp;gt; 选「Network 2」 -&amp;gt; 确定。之后 Windows 会自动把「Network 2」的 IP 设置成 192.168.137.1，并且在这个网络上启动一个 DHCP 服务器。我不太懂 Windows 为啥要把 IP 改成这个，用原来的不好么？&lt;/p&gt;
&lt;p&gt;在 Linux 上对 qbr0 启动 dhcpcd，qbr0 会自动分配到一个 192.168.137.X/24 的地址，当然也可以手动设置，只要在这个网段内就可以了。再配置一下路由表，让内网的 IP 走 qbr0 接口就好了：&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
ip r add 10.0.0.0/8 via 192.168.137.1 dev qbr0
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;画张图&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;其实很好理解，现在访问内网的路由大概是这样：&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
                               (VPN)                          (ICS)
Guest(Windows)    [Network 1] &amp;lt;----- [spicy chicken sangfor] &amp;lt;----- [Network 2]
                       |                                                 ^
                       | (SLiRP)                                         |
-----------------------|-------------------------------------------------|-------------
                       |                                                 |
                       v                                                 |
Host(Linux)          [eth0]                                           [qbr0] &amp;lt;- [tap0]
                       |                                                          ^
                       v                                                          |
                     target                                                    request
&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;EOF&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="sangfor"></category><category term="vpn"></category><category term="linux"></category></entry><entry><title>记一次打败坑爹魅族的手机管家经历</title><link href="https://zsrkmyn.github.io/how-do-i-fvck-flymed.html" rel="alternate"></link><published>2017-07-20T00:00:00+08:00</published><updated>2017-07-20T00:00:00+08:00</updated><author><name>Stephen Zhang</name></author><id>tag:zsrkmyn.github.io,2017-07-20:/how-do-i-fvck-flymed.html</id><summary type="html">&lt;div class="contents topic" id="contents"&gt;
&lt;p class="topic-title"&gt;Contents&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id7"&gt;吐槽&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id8"&gt;问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id9"&gt;折腾&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id6" id="id10"&gt;丑陋的解决方案&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;吐槽&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;前两天我的魅族手机终于在过保 10 天前达成了 同一部件损坏成就 [3/3] ！于是根据魅族的售后政策，果断申请了换新。新手机到之后，由于辣鸡魅族不让刷第三方固件，我选择更新到了 flyme 5 的最后一个稳定版本。&lt;/p&gt;
&lt;p&gt;之所以没更新到 flyme 6，是因为 6 相比 5 多了很多产品经理帮用户作出的脑残决定。诸如新增了“智能”通知栏，大概是就是把垃圾通知屏蔽了，然而它一点也不智能，经常把我的 Gmail 呀、微信呀之类重要通知屏蔽了，最脑残的是，这货没有白名单机制，也就是说，用户不能选择屏蔽哪些应用不屏蔽哪些应用，所有的屏蔽都是由系统“智能”决定的！还有那个“安全”键盘，每次输密码的时候强制使用，还把数字打乱，极大降低了打字效率 …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;div class="contents topic" id="contents"&gt;
&lt;p class="topic-title"&gt;Contents&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id7"&gt;吐槽&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id8"&gt;问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id9"&gt;折腾&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id6" id="id10"&gt;丑陋的解决方案&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;吐槽&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;前两天我的魅族手机终于在过保 10 天前达成了 同一部件损坏成就 [3/3] ！于是根据魅族的售后政策，果断申请了换新。新手机到之后，由于辣鸡魅族不让刷第三方固件，我选择更新到了 flyme 5 的最后一个稳定版本。&lt;/p&gt;
&lt;p&gt;之所以没更新到 flyme 6，是因为 6 相比 5 多了很多产品经理帮用户作出的脑残决定。诸如新增了“智能”通知栏，大概是就是把垃圾通知屏蔽了，然而它一点也不智能，经常把我的 Gmail 呀、微信呀之类重要通知屏蔽了，最脑残的是，这货没有白名单机制，也就是说，用户不能选择屏蔽哪些应用不屏蔽哪些应用，所有的屏蔽都是由系统“智能”决定的！还有那个“安全”键盘，每次输密码的时候强制使用，还把数字打乱，极大降低了打字效率。而且这两个功能都是用户没法关闭的，实在是没法忍受。&lt;/p&gt;
&lt;p&gt;拿到新手机后，看了看魅族的保修政策，居然又有新的一年的保修期，不得不说，魅族的品控虽然不咋，但售后还真是蛮良心的！无论去售后中心，还是网上客户，或者是电话客户，态度都很棒，这点要点个赞！本来想着过保了就 root，但现在又有了新的一年，不能忍了，所以还是选择了解锁 root。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;问题&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;然后新的问题出现了！安装科学上网工具之后，发现居然没法使用！开启 SS 后，基本上每隔半分钟就要重新进入 SS 程序主界面重新唤醒，不能忍啊！你想你在看个网页，每半分钟得切出浏览器再切回来，ingress 放两三个 xmp 又切出去得重新唤醒一次，多难受啊！我尝试找遍了魅族所有能设置的地方，包括自带的手机管家里的自启动权限、后台保留权限、联网权限，一切该设置的都设置了，能拖白名单的地方都拖白名单了，还是没能解决这个问题。而且在联网失败的时候通过 &lt;tt class="docutils literal"&gt;ps&lt;/tt&gt; 查看进程，SS 的几个进程完全正常没有被杀，在换手机前使用这个版本的固件也没有出现过这样的问题，所以我一度怀疑是 SS 自己的问题，回滚了 SS 几个版本后，问题依然得不到解决。不能忍了，决心好好研究下这个问题。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id4"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id9"&gt;折腾&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;既然进程运行正常没有被后台管理杀了，那么如果是程序自己的错误，就应该从日志查起。果然，&lt;tt class="docutils literal"&gt;adb logcat&lt;/tt&gt; 看到一堆报错！&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
$ adb logcat sha自dso由cks:V *:S
E/sha自dso由cks(15911): connect: Network is unreachable
E/sha自dso由cks(15911): connect: Network is unreachable
E/sha自dso由cks(15911): connect: Network is unreachable
E/sha自dso由cks(15911): connect: Network is unreachable
E/sha自dso由cks(15911): connect: Network is unreachable
E/sha自dso由cks(15924): getpeername: Transport endpoint is not connected
E/sha自dso由cks(15924): getpeername: Transport endpoint is not connected
E/sha自dso由cks(15924): getpeername: Transport endpoint is not connected
E/sha自dso由cks(15924): getpeername: Transport endpoint is not connected
E/sha自dso由cks(15924): getpeername: Transport endpoint is not connected
&lt;/pre&gt;
&lt;p&gt;而且正好这些报错都是在浏览器无法正常访问后出现，问题应该就在这了。看了看 ss-libev 的代码，应该是在连接远程服务器时出错的，然而我的手机直接访问远程服务器正常啊！好吧，用 &lt;tt class="docutils literal"&gt;watch &lt;span class="pre"&gt;-n1&lt;/span&gt; &amp;quot;netstat &lt;span class="pre"&gt;-atnp&amp;quot;&lt;/span&gt;&lt;/tt&gt; 看看连接状态，发现断网后 SS 不停地进入 SYN_SENT 状态，然后连接马上就断了。那就抓包吧！之前看过万能的百合仙子的一篇 &lt;a class="reference external" href="https://blog.lilydjwg.me/2015/6/1/wireshark-capturing-over-ssh.95147.html"&gt;文章&lt;/a&gt; 讲如何用 wireshark 远程抓包，这次正好用上了：&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
$ nc -l 8899 | wireshark-gtk -i - -k                     # 电脑端 nc 收包然后传给 wireshark
# tcpdump -U -w - -p -f 'port 8388' | nc &amp;lt;ip_addr&amp;gt; 8899  # 手机端用 tcpdump 抓包发送给 nc
&lt;/pre&gt;
&lt;p&gt;当然似乎可以直接用 adb 执行 &lt;tt class="docutils literal"&gt;tcpdump&lt;/tt&gt; 命令把输出传给 wireshark ，然而我对 adb 不熟，不懂怎么直接以 root 执行命令……开始抓包时一切正常，浏览器也能正常访问网页，不到半分钟果然网断了，这时候 wireshark 这边居然一个包都收不到了！之前说过断网的时候 SS 是会调用 &lt;tt class="docutils literal"&gt;connect&lt;/tt&gt; 然后进入 SYN_WAIT 状态的，然而现在连 SYN 包的影子都没见到！既然连 TCP 包都直接被阻断了，直接想到就是被内核过滤，执行 &lt;tt class="docutils literal"&gt;iptables&lt;/tt&gt; 查看防火墙策略：&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
(ins)root&amp;#64;localhost /# /system/bin/iptables -L -v
...
Chain mobile (13 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a133 reject-with icmp-net-prohibited
    0     0 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a113 reject-with icmp-net-prohibited
    0     0 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a128 reject-with icmp-net-prohibited
...
Chain wifi (1 references)
 pkts bytes target     prot opt in     out     source               destination
   88  5815 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a133 reject-with icmp-net-prohibited
    0     0 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a113 reject-with icmp-net-prohibited
    0     0 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a128 reject-with icmp-net-prohibited
...
&lt;/pre&gt;
&lt;p&gt;哈哈，果然！我的 SS 的用户是 u0_a133, 果然是被防火墙过滤了，被过滤的还有其他一些被我添加到联网黑名单的程序！那么到底是什么东西修改的防火墙表呢？想一个一个进程去追踪也没那么容易，只好先看看日志来碰碰运气吧……&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
(ins)root&amp;#64;localhost /# logcat |grep iptables
E/flymed  (  362): exec() res=0, status=0 for /system/bin/iptables -I wifi -m owner --uid-owner 10133 -j REJECT --reject-with icmp-net-prohibited
E/flymed  (  362): exec() res=0, status=0 for /system/bin/iptables -I mobile -m owner --uid-owner 10133 -j REJECT --reject-with icmp-net-prohibited
&lt;/pre&gt;
&lt;p&gt;不得不说，运气真是太好，感觉一个月人品都被败光了……明天支付宝的奖励金应该会少很多吧 _(:з」∠)_&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id6"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;丑陋的解决方案&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;用 &lt;tt class="docutils literal"&gt;ps aux | grep flymed&lt;/tt&gt; 可以看到 flymed 的启动命令是 &lt;tt class="docutils literal"&gt;/system/bin/flymed&lt;/tt&gt; 且 ppid 是 1，原生的二进制文件。由于手机管家只是一个普通的安卓应用，而且清除手机管家的数据后再启动手机管家后发现黑名单并没有改变，说明这些黑名单一定是存在手机管家数据之外的地方。之后用 &lt;tt class="docutils literal"&gt;strace&lt;/tt&gt; 追踪了 &lt;tt class="docutils literal"&gt;flymed&lt;/tt&gt; ，发现这货和手机管家用 unix socket 进行通信，设置黑白名单的时候手机管家通过 socket 传一条指令给 &lt;tt class="docutils literal"&gt;flymed&lt;/tt&gt; ， &lt;tt class="docutils literal"&gt;flymed&lt;/tt&gt; 收到后会修改防火墙，然而却没有发现任何的文件写入操作，再之后用 &lt;tt class="docutils literal"&gt;ls &lt;span class="pre"&gt;-l&lt;/span&gt; &lt;span class="pre"&gt;/proc/`pidof&lt;/span&gt; &lt;span class="pre"&gt;flymed`/fd&lt;/span&gt;&lt;/tt&gt; 查看了这货打开的文件，也没能找到线索。最终用 &lt;tt class="docutils literal"&gt;grep&lt;/tt&gt; + 人眼暴力搜索，在 &lt;tt class="docutils literal"&gt;/data/system/&lt;/tt&gt; 找到了联网黑名单 &lt;tt class="docutils literal"&gt;netpolicy.xml&lt;/tt&gt; ，应用权限配置 &lt;tt class="docutils literal"&gt;appops.xml&lt;/tt&gt; ， 然而一切都是正常的，没有对 u0_a133 的封杀规则……所以，我猜对 SS 的联网限制大概又是魅族产品经理/工程师推出的“智能”操作吧……&lt;/p&gt;
&lt;p&gt;既然不能通过修改策略完成，那就直接 &lt;tt class="docutils literal"&gt;kill `pidof flymed`&lt;/tt&gt; 吧！kill 之后发现 init 进程立刻把它重启了 _(:з」∠)_。没办法了，我只好写了个伪程序来把它替换掉了……在电脑上用 &lt;tt class="docutils literal"&gt;echo &lt;span class="pre"&gt;-e&lt;/span&gt; &lt;span class="pre"&gt;'#include&amp;lt;unistd.h&amp;gt;\n#include&amp;lt;limits.h&amp;gt;\nint&lt;/span&gt; &lt;span class="pre"&gt;main(){&lt;/span&gt; &lt;span class="pre"&gt;for(;;)sleep(UINT_MAX);&lt;/span&gt; }' | &lt;span class="pre"&gt;aarch64-linux-gnu-gcc&lt;/span&gt; &lt;span class="pre"&gt;-xc&lt;/span&gt; &lt;span class="pre"&gt;-s&lt;/span&gt; &lt;span class="pre"&gt;-static&lt;/span&gt; &lt;span class="pre"&gt;-o&lt;/span&gt; flymed -&lt;/tt&gt; 交叉编译了一个静态链接的 flymed 然后把 &lt;tt class="docutils literal"&gt;/system/bin&lt;/tt&gt; 里的替换掉，再 kill 一次，整个世界都变得美好了。&lt;/p&gt;
&lt;p&gt;虽然失去了 flymed 可能会让手机管家没法工作，但是用 xposed 可以很好地解决这个问题吧。除此之外，目前手机还没有出现任何异常。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;EOF&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="flyme"></category><category term="折腾"></category></entry></feed>