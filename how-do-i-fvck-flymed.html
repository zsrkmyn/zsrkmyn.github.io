<!DOCTYPE html><html lang=zh><head><link href=http://gmpg.org/xfn/11 rel=profile><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=content-type content="text/html; charset=utf-8"><meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1"><title>Stephen's Home</title><link href=//fonts.googleapis.com/ rel=dns-prefetch><link href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Abril+Fatface|PT+Sans:400,400italic,700&subset=latin,latin-ext" rel=stylesheet><link rel=stylesheet href=./theme/css/poole.css><link rel=stylesheet href=./theme/css/hyde.css><link rel=stylesheet href=./theme/css/syntax.css><link rel=stylesheet href=./theme/css/custom.css><link rel=stylesheet href=./theme/css/math.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css><link rel=alternate type=application/rss+xml title=RSS href=/atom.xml><script type=text/javascript>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
			ga('create', 'UA-102901287-1', 'auto');
			ga('send', 'pageview');
	</script></head><body class=theme-base-0d><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><h1><a href=/ ><img class=profile-picture src=./images/avatar.jpg> Stephen's Home </a></h1><p class=lead></p><p class=lead>Lazy... </p><p></p></div><nav class=sidebar-nav><a class=sidebar-nav-item href=mailto:zsrkmyn@gmail.com><i class="fa fa-envelope"></i></a><a class=sidebar-nav-item href=https://twitter.com/zsrkmyn><i class="fa fa-twitter"></i></a><a class=sidebar-nav-item href=https://www.linkedin.com/in/zsrkmyn><i class="fa fa-linkedin"></i></a><a class=sidebar-nav-item href=https://github.com/zsrkmyn><i class="fa fa-github"></i></a><a class=sidebar-nav-item href=feeds/all.atom.xml><i class="fa fa-feed"></i></a></nav></div></div><div class="content container"><div class=post><h1 class=post-title>记一次打败坑爹魅族的手机管家经历</h1><span class=post-date>Thu 20 July 2017</span><div class="contents topic" id=contents><p class=topic-title>Contents</p><ul class=simple><li><a class="reference internal" href=#id2 id=id7>吐槽</a></li><li><a class="reference internal" href=#id3 id=id8>问题</a></li><li><a class="reference internal" href=#id4 id=id9>折腾</a></li><li><a class="reference internal" href=#id6 id=id10>丑陋的解决方案</a></li></ul></div><div class=section id=id2><h2><a class=toc-backref href=#id7>吐槽</a></h2><p>前两天我的魅族手机终于在过保 10 天前达成了 同一部件损坏成就 [3/3] ！于是根据魅族的售后政策，果断申请了换新。新手机到之后，由于辣鸡魅族不让刷第三方固件，我选择更新到了 flyme 5 的最后一个稳定版本。</p><p>之所以没更新到 flyme 6，是因为 6 相比 5 多了很多产品经理帮用户作出的脑残决定。诸如新增了“智能”通知栏，大概是就是把垃圾通知屏蔽了，然而它一点也不智能，经常把我的 Gmail 呀、微信呀之类重要通知屏蔽了，最脑残的是，这货没有白名单机制，也就是说，用户不能选择屏蔽哪些应用不屏蔽哪些应用，所有的屏蔽都是由系统“智能”决定的！还有那个“安全”键盘，每次输密码的时候强制使用，还把数字打乱，极大降低了打字效率。而且这两个功能都是用户没法关闭的，实在是没法忍受。</p><p>拿到新手机后，看了看魅族的保修政策，居然又有新的一年的保修期，不得不说，魅族的品控虽然不咋，但售后还真是蛮良心的！无论去售后中心，还是网上客户，或者是电话客户，态度都很棒，这点要点个赞！本来想着过保了就 root，但现在又有了新的一年，不能忍了，所以还是选择了解锁 root。</p></div><div class=section id=id3><h2><a class=toc-backref href=#id8>问题</a></h2><p>然后新的问题出现了！安装科学上网工具之后，发现居然没法使用！开启 SS 后，基本上每隔半分钟就要重新进入 SS 程序主界面重新唤醒，不能忍啊！你想你在看个网页，每半分钟得切出浏览器再切回来，ingress 放两三个 xmp 又切出去得重新唤醒一次，多难受啊！我尝试找遍了魅族所有能设置的地方，包括自带的手机管家里的自启动权限、后台保留权限、联网权限，一切该设置的都设置了，能拖白名单的地方都拖白名单了，还是没能解决这个问题。而且在联网失败的时候通过 <tt class="docutils literal">ps</tt> 查看进程，SS 的几个进程完全正常没有被杀，在换手机前使用这个版本的固件也没有出现过这样的问题，所以我一度怀疑是 SS 自己的问题，回滚了 SS 几个版本后，问题依然得不到解决。不能忍了，决心好好研究下这个问题。</p></div><div class=section id=id4><h2><a class=toc-backref href=#id9>折腾</a></h2><p>既然进程运行正常没有被后台管理杀了，那么如果是程序自己的错误，就应该从日志查起。果然，<tt class="docutils literal">adb logcat</tt> 看到一堆报错！</p><pre class="code literal-block">
$ adb logcat sha自dso由cks:V *:S
E/sha自dso由cks(15911): connect: Network is unreachable
E/sha自dso由cks(15911): connect: Network is unreachable
E/sha自dso由cks(15911): connect: Network is unreachable
E/sha自dso由cks(15911): connect: Network is unreachable
E/sha自dso由cks(15911): connect: Network is unreachable
E/sha自dso由cks(15924): getpeername: Transport endpoint is not connected
E/sha自dso由cks(15924): getpeername: Transport endpoint is not connected
E/sha自dso由cks(15924): getpeername: Transport endpoint is not connected
E/sha自dso由cks(15924): getpeername: Transport endpoint is not connected
E/sha自dso由cks(15924): getpeername: Transport endpoint is not connected
</pre><p>而且正好这些报错都是在浏览器无法正常访问后出现，问题应该就在这了。看了看 ss-libev 的代码，应该是在连接远程服务器时出错的，然而我的手机直接访问远程服务器正常啊！好吧，用 <tt class="docutils literal">watch <span class=pre>-n1</span> &quot;netstat <span class=pre>-atnp&quot;</span></tt> 看看连接状态，发现断网后 SS 不停地进入 SYN_SENT 状态，然后连接马上就断了。那就抓包吧！之前看过万能的百合仙子的一篇 <a class="reference external" href=https://blog.lilydjwg.me/2015/6/1/wireshark-capturing-over-ssh.95147.html>文章</a> 讲如何用 wireshark 远程抓包，这次正好用上了：</p><pre class="code literal-block">
$ nc -l 8899 | wireshark-gtk -i - -k                     # 电脑端 nc 收包然后传给 wireshark
# tcpdump -U -w - -p -f 'port 8388' | nc &lt;ip_addr&gt; 8899  # 手机端用 tcpdump 抓包发送给 nc
</pre><p>当然似乎可以直接用 adb 执行 <tt class="docutils literal">tcpdump</tt> 命令把输出传给 wireshark ，然而我对 adb 不熟，不懂怎么直接以 root 执行命令……开始抓包时一切正常，浏览器也能正常访问网页，不到半分钟果然网断了，这时候 wireshark 这边居然一个包都收不到了！之前说过断网的时候 SS 是会调用 <tt class="docutils literal">connect</tt> 然后进入 SYN_WAIT 状态的，然而现在连 SYN 包的影子都没见到！既然连 TCP 包都直接被阻断了，直接想到就是被内核过滤，执行 <tt class="docutils literal">iptables</tt> 查看防火墙策略：</p><pre class="code literal-block">
(ins)root&#64;localhost /# /system/bin/iptables -L -v
...
Chain mobile (13 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a133 reject-with icmp-net-prohibited
    0     0 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a113 reject-with icmp-net-prohibited
    0     0 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a128 reject-with icmp-net-prohibited
...
Chain wifi (1 references)
 pkts bytes target     prot opt in     out     source               destination
   88  5815 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a133 reject-with icmp-net-prohibited
    0     0 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a113 reject-with icmp-net-prohibited
    0     0 REJECT     all  --  any    any     anywhere             anywhere             owner UID match u0_a128 reject-with icmp-net-prohibited
...
</pre><p>哈哈，果然！我的 SS 的用户是 u0_a133, 果然是被防火墙过滤了，被过滤的还有其他一些被我添加到联网黑名单的程序！那么到底是什么东西修改的防火墙表呢？想一个一个进程去追踪也没那么容易，只好先看看日志来碰碰运气吧……</p><pre class="code literal-block">
(ins)root&#64;localhost /# logcat |grep iptables
E/flymed  (  362): exec() res=0, status=0 for /system/bin/iptables -I wifi -m owner --uid-owner 10133 -j REJECT --reject-with icmp-net-prohibited
E/flymed  (  362): exec() res=0, status=0 for /system/bin/iptables -I mobile -m owner --uid-owner 10133 -j REJECT --reject-with icmp-net-prohibited
</pre><p>不得不说，运气真是太好，感觉一个月人品都被败光了……明天支付宝的奖励金应该会少很多吧 _(:з」∠)_</p></div><div class=section id=id6><h2><a class=toc-backref href=#id10>丑陋的解决方案</a></h2><p>用 <tt class="docutils literal">ps aux | grep flymed</tt> 可以看到 flymed 的启动命令是 <tt class="docutils literal">/system/bin/flymed</tt> 且 ppid 是 1，原生的二进制文件。由于手机管家只是一个普通的安卓应用，而且清除手机管家的数据后再启动手机管家后发现黑名单并没有改变，说明这些黑名单一定是存在手机管家数据之外的地方。之后用 <tt class="docutils literal">strace</tt> 追踪了 <tt class="docutils literal">flymed</tt> ，发现这货和手机管家用 unix socket 进行通信，设置黑白名单的时候手机管家通过 socket 传一条指令给 <tt class="docutils literal">flymed</tt> ， <tt class="docutils literal">flymed</tt> 收到后会修改防火墙，然而却没有发现任何的文件写入操作，再之后用 <tt class="docutils literal">ls <span class=pre>-l</span> <span class=pre>/proc/`pidof</span> <span class=pre>flymed`/fd</span></tt> 查看了这货打开的文件，也没能找到线索。最终用 <tt class="docutils literal">grep</tt> + 人眼暴力搜索，在 <tt class="docutils literal">/data/system/</tt> 找到了联网黑名单 <tt class="docutils literal">netpolicy.xml</tt> ，应用权限配置 <tt class="docutils literal">appops.xml</tt> ， 然而一切都是正常的，没有对 u0_a133 的封杀规则……所以，我猜对 SS 的联网限制大概又是魅族产品经理/工程师推出的“智能”操作吧……</p><p>既然不能通过修改策略完成，那就直接 <tt class="docutils literal">kill `pidof flymed`</tt> 吧！kill 之后发现 init 进程立刻把它重启了 _(:з」∠)_。没办法了，我只好写了个伪程序来把它替换掉了……在电脑上用 <tt class="docutils literal">echo <span class=pre>-e</span> <span class=pre>'#include&lt;unistd.h&gt;\n#include&lt;limits.h&gt;\nint</span> <span class=pre>main(){</span> <span class=pre>for(;;)sleep(UINT_MAX);</span> }' | <span class=pre>aarch64-linux-gnu-gcc</span> <span class=pre>-xc</span> <span class=pre>-s</span> <span class=pre>-static</span> <span class=pre>-o</span> flymed -</tt> 交叉编译了一个静态链接的 flymed 然后把 <tt class="docutils literal">/system/bin</tt> 里的替换掉，再 kill 一次，整个世界都变得美好了。</p><p>虽然失去了 flymed 可能会让手机管家没法工作，但是用 xposed 可以很好地解决这个问题吧。除此之外，目前手机还没有出现任何异常。</p><p><strong>EOF</strong></p></div><div id=disqus_thread></div><script type=text/javascript>
			var disqus_shortname = 'stephens-home';
			(function() {
	 			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	 			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	 			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	 		})();
		</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div><footer id=footer><hr><div class=container><div class=row><div class=col-md-24><p><small> &copy; 2024 Stephen Zhang &middot; <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ rel=license><img alt="Creative Commons License" style=margin:0;display:inline;border-width:0 src=//i.creativecommons.org/l/by-nc-sa/4.0/80x15.png></a><br> Powered by <a href=http://docs.getpelican.com/ target=_blank>Pelican</a> generator &middot; Theme modified from <a href=https://github.com/jvanz/pelican-hyde>pelican-hyde</a></small></p></div></div></div><a href=# class="btn btn-primary btn-fab btn-raised mdi-editor-vertical-align-top withripple" style=position:fixed;bottom:30px;right:30px;z-index:1000></a></footer></div></body></html>